

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UART with DMA &mdash; Embedded Tutorials 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=e5e1bfdb" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/custom.js?v=5fde6192"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="UART Issues" href="uart_issues.html" />
    <link rel="prev" title="UART with Interrupt" href="uart_interrupt.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Embedded Tutorials
              <img src="../../_static/embedded-logo.webp" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../stm32_basics_tutorial.html">STM32 Basics Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basic_setup.html">Basic Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio.html">GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb.html">USB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../swd.html">SWD</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../uart.html">UART</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="uart_polling.html">UART with Polling</a></li>
<li class="toctree-l3"><a class="reference internal" href="uart_interrupt.html">UART with Interrupt</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">UART with DMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="uart_issues.html">UART Issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../timer.html">Timer</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../intermediate_tutorial.html">Intermediate Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../highlights.html">Highlights</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Embedded Tutorials</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../stm32_basics_tutorial.html">STM32 Basics Tutorial</a></li>
          <li class="breadcrumb-item"><a href="../uart.html">UART</a></li>
      <li class="breadcrumb-item active">UART with DMA</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Robotics-Club-Pulchowk/EmbeddedTutorials/blob/main/source/stm32_basics_tutorial/uart/uart_dma.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="uart-with-dma">
<h1>UART with DMA<a class="headerlink" href="#uart-with-dma" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">1. Introduction</a></p></li>
<li><p><a class="reference internal" href="#cubemx-configuration" id="id2">2. CubeMX Configuration</a></p></li>
<li><p><a class="reference internal" href="#code-to-send-and-receive-data-using-uart-interrupt" id="id3">3. Code to Send and Receive Data using UART Interrupt</a></p></li>
<li><p><a class="reference internal" href="#connection" id="id4">4. Connection</a></p></li>
<li><p><a class="reference internal" href="#references" id="id5">References</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">1. Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Direct Memory Access (DMA) is very useful feature in microcontrollers. It allows data transfer between peripherals and memory without CPU intervention. This is very useful in UART communication where data is received and transmitted continuously. In this tutorial, we will learn how to use UART with DMA.</p>
</section>
<section id="cubemx-configuration">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">2. CubeMX Configuration</a><a class="headerlink" href="#cubemx-configuration" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Open CubeMX and <a class="reference external" href="../basic_setup/generate_basic_code.html">generate basic code</a> with:</p>
<ul>
<li><p>microcontroller: <code class="docutils literal notranslate"><span class="pre">stm32f407vgt6</span></code> or board: <code class="docutils literal notranslate"><span class="pre">STM32F407VG-DISC1</span></code></p></li>
<li><p>project name: <code class="docutils literal notranslate"><span class="pre">usb_polling</span></code></p></li>
<li><p>Toolchain/IDE: <code class="docutils literal notranslate"><span class="pre">Makefile</span></code></p></li>
</ul>
</li>
<li><p>Move to STM32CubeMX <code class="docutils literal notranslate"><span class="pre">Pinout</span> <span class="pre">and</span> <span class="pre">Congiguration</span></code>. From <code class="docutils literal notranslate"><span class="pre">Categories</span></code>, select <code class="docutils literal notranslate"><span class="pre">Connectivity</span> <span class="pre">&gt;</span> <span class="pre">USART2</span></code>. Change <code class="docutils literal notranslate"><span class="pre">mode</span></code> to <code class="docutils literal notranslate"><span class="pre">Asynchronous</span></code> mode.</p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">DMA</span> <span class="pre">Settings</span></code>, add <code class="docutils literal notranslate"><span class="pre">USART2_RX</span></code> and <code class="docutils literal notranslate"><span class="pre">USART2_TX</span></code> DMA request.</p></li>
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Configuration</span> <span class="pre">&gt;</span> <span class="pre">NVIC</span> <span class="pre">Settings</span></code>, enable <code class="docutils literal notranslate"><span class="pre">USART2</span> <span class="pre">global</span> <span class="pre">interrupt</span></code>.</p></li>
</ul>
<a class="reference internal image-reference" href="../../_images/uart_dma.webp"><img alt="usart2_dma" class="align-center" src="../../_images/uart_dma.webp" style="width: 100%;" />
</a>
<ul class="simple">
<li><p>Generate code and open the project.</p></li>
</ul>
</section>
<section id="code-to-send-and-receive-data-using-uart-interrupt">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">3. Code to Send and Receive Data using UART Interrupt</a><a class="headerlink" href="#code-to-send-and-receive-data-using-uart-interrupt" title="Link to this heading"></a></h2>
<ul>
<li><p>Navigate to <code class="docutils literal notranslate"><span class="pre">Core</span> <span class="pre">&gt;</span> <span class="pre">Src</span></code> and open <code class="docutils literal notranslate"><span class="pre">main.c</span></code>.</p></li>
<li><p>Include <code class="docutils literal notranslate"><span class="pre">stdio.h</span></code> for printf to print received data.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* USER CODE BEGIN Includes */</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cm">/* USER CODE END Includes */</span>
</pre></div>
</div>
</li>
<li><p>Overwrite definition of <code class="docutils literal notranslate"><span class="pre">_write</span></code> as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* USER CODE BEGIN 0 */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">_write</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">ITM_SendChar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* USER CODE END 0 */</span>
</pre></div>
</div>
</li>
<li><p>Add global variable to store received data.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* USER CODE BEGIN PV */</span>
<span class="kt">char</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="cm">/* USER</span>
</pre></div>
</div>
</li>
<li><p>Add code for sending as well as receiving in <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="cm">/* USER CODE BEGIN 2 */</span>
<span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">msg</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello from controller 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w"> </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span><span class="w"> </span><span class="c1">// Start receiving</span>
<span class="w"> </span><span class="cm">/* USER CODE END 2 */</span>

<span class="w"> </span><span class="cm">/* Infinite loop */</span>
<span class="w"> </span><span class="cm">/* USER CODE BEGIN WHILE */</span>
<span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">last_transmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">HAL_GetTick</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_transmit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">     </span><span class="n">HAL_UART_Transmit_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
<span class="w">     </span><span class="n">last_transmit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HAL_GetTick</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HAL_UART_GetState</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">HAL_UART_STATE_BUSY_RX</span><span class="p">))</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">    </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span><span class="w"> </span><span class="c1">// Start receiving in case of no reception</span>
<span class="w">   </span><span class="p">}</span>
<span class="cm">/* USER CODE END WHILE */</span>

<span class="cm">/* USER CODE BEGIN 3 */</span>
<span class="p">}</span>
<span class="cm">/* USER CODE END 3 */</span>
</pre></div>
</div>
</li>
<li><p>Add callback function for UART RX DMA just above <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_RxCpltCallback</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">huart</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">USART2</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="n">HAL_UART_Receive_DMA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart2</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">));</span><span class="w"> </span><span class="c1">// Receive again</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* USER CODE END 0 */</span>
</pre></div>
</div>
</li>
<li><p>Build and flash the code to both controllers.</p></li>
</ul>
</section>
<section id="connection">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">4. Connection</a><a class="headerlink" href="#connection" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Connect <strong>TX pin</strong> of sender to <strong>RX pin</strong> of receiver.</p></li>
<li><p>Connect <strong>GND</strong> of both controllers together.</p></li>
</ul>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p>References are from <code class="docutils literal notranslate"><span class="pre">STM32</span> <span class="pre">HAL</span> <span class="pre">Driver</span></code> documentation.</p>
<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">HAL_StatusTypeDef</span> <span class="pre">HAL_UART_Transmit_DMA(UART_HandleTypeDef</span> <span class="pre">*huart,</span> <span class="pre">const</span> <span class="pre">uint8_t</span> <span class="pre">*pData,</span> <span class="pre">uint16_t</span> <span class="pre">Size)</span></span></dt>
<dd><p>Sends an amount of data in DMA mode.</p>
<p><strong>Notes</strong>:
- When UART parity is not enabled (<cite>PCE = 0</cite>) and Word Length is configured to 9 bits (<cite>M1-M0 = 01</cite>), the sent data is handled as a set of <cite>u16</cite>. In this case, <em>Size</em> must indicate the number of <cite>u16</cite> provided through <em>pData</em>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>huart</strong> – Pointer to a <cite>UART_HandleTypeDef</cite> structure containing configuration information for the specified UART module.</p></li>
<li><p><strong>pData</strong> – Pointer to data buffer (contains <cite>u8</cite> or <cite>u16</cite> data elements).</p></li>
<li><p><strong>Size</strong> – Number of data elements (<cite>u8</cite> or <cite>u16</cite>) to be sent.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>HAL status.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>HAL_StatusTypeDef</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">HAL_StatusTypeDef</span> <span class="pre">HAL_UART_Receive_DMA(UART_HandleTypeDef</span> <span class="pre">*huart,</span> <span class="pre">uint8_t</span> <span class="pre">*pData,</span> <span class="pre">uint16_t</span> <span class="pre">Size)</span></span></dt>
<dd><p>Receives an amount of data in DMA mode.</p>
<p><strong>Notes</strong>:
- When UART parity is not enabled (<cite>PCE = 0</cite>) and Word Length is configured to 9 bits (<cite>M1-M0 = 01</cite>), the received data is handled as a set of <cite>u16</cite>. In this case, <em>Size</em> must indicate the number of <cite>u16</cite> available through <em>pData</em>.
- When the UART parity is enabled (<cite>PCE = 1</cite>), the received data contains the parity bit.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>huart</strong> – Pointer to a <cite>UART_HandleTypeDef</cite> structure containing configuration information for the specified UART module.</p></li>
<li><p><strong>pData</strong> – Pointer to data buffer (contains <cite>u8</cite> or <cite>u16</cite> data elements).</p></li>
<li><p><strong>Size</strong> – Number of data elements (<cite>u8</cite> or <cite>u16</cite>) to be received.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>HAL status.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>HAL_StatusTypeDef</p>
</dd>
</dl>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="uart_interrupt.html" class="btn btn-neutral float-left" title="UART with Interrupt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="uart_issues.html" class="btn btn-neutral float-right" title="UART Issues" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Robotics Club, Pulchowk Campus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>